#include "game_fruit_fury_led_driver.h"
#include "graphics_equalizer.h"

#define MAX_ROW 32
#define MAX_COL 64
#define MAX_FREQ_BANDS 7

static uint8_t band_matrix[MAX_ROW][MAX_COL];
static uint16_t freq[MAX_FREQ_BANDS], band_height[MAX_FREQ_BANDS];

static void construct_band_matrix() {
  uint8_t row, col;
  memset(band_matrix, 0, sizeof(band_matrix));

  for (row = MAX_ROW - 1; row >= 1; row--) {
    for (col = 7; col <= 62; col++) {
      if ((row >= (MAX_ROW - band_height[0])) && col >= 7 && col <= 13) {
        band_matrix[row][col] = 1;
      }
      if ((row >= (MAX_ROW - band_height[1])) && col >= 14 && col <= 20) {
        band_matrix[row][col] = 2;
      }
      if ((row >= (MAX_ROW - band_height[2])) && col >= 21 && col <= 27) {
        band_matrix[row][col] = 3;
      }
      if ((row >= (MAX_ROW - band_height[3])) && col >= 28 && col <= 34) {
        band_matrix[row][col] = 4;
      }
      if ((row >= (MAX_ROW - band_height[4])) && col >= 35 && col <= 41) {
        band_matrix[row][col] = 5;
      }
      if ((row >= (MAX_ROW - band_height[5])) && col >= 42 && col <= 48) {
        band_matrix[row][col] = 6;
      }
      if ((row >= (MAX_ROW - band_height[6])) && col >= 49 && col <= 55) {
        band_matrix[row][col] = 7;
      }
    }
  }
}

static void get_freq_values() {
  graphics_equalizer__read_frequency(&freq[0]);
  uint16_t result;
  for (int i = 0; i < MAX_FREQ_BANDS; i++) {
    result = freq[i] * 0.9;
    if (result < 500)
      result = 0;
    result = result / 128;
    if (result < 12)
      band_height[i] = 1;
    else {
      band_height[i] = result;
    }
  }
  construct_band_matrix();
}

static void display_band_matrix() {
#if 0
  uint8_t row, col;
  // for (uint8_t k = 0; k < 10; k++) {
  for (row = 0; row < (MAX_ROW / 2); row++) {
    disableOE();
    set_row(row);
    for (col = 0; col < MAX_COL; col++) {
      LPC_GPIO0->PIN |= (1 << CLK);
      set_color_bottom(band_matrix[row + (MAX_ROW / 2)][col]);
      set_color_top(band_matrix[row][col]);
      LPC_GPIO0->PIN &= ~(1 << CLK);
    }
    LPC_GPIO0->PIN |= (1 << LAT);
    LPC_GPIO0->PIN &= ~(1 << LAT);
    enableOE();
    vTaskDelay(1);
  }
  vTaskDelay(2);
  // }
#endif
#if 1
  uint8_t row, col;
  for (uint8_t k = 0; k < 2; k++) {
    for (row = 0; row < MAX_ROW; row++) {
      disableOE();
      set_row(row);
      for (col = 0; col < MAX_COL; col++) {
        LPC_GPIO0->PIN |= (1 << CLK);
        if (row > 0 && row < (MAX_ROW / 2)) {
          set_color_top(band_matrix[row][col]);
        }
        set_color_bottom(band_matrix[row][col]);
        LPC_GPIO0->PIN &= ~(1 << CLK);
      }
      LPC_GPIO0->PIN |= (1 << LAT);
      LPC_GPIO0->PIN &= ~(1 << LAT);
      enableOE();
      vTaskDelay(1);
    }
  }
#endif
}

static void display_freq_bands() {
  while (1) {
    printf("Inside task\r\n");
    get_freq_values();
    display_band_matrix();
    vTaskDelay(20);
  }
}

void led_test(void) {
  led_init();
  graphics_equalizer__init();
  xTaskCreate(display_freq_bands, "display_freq_bands", 1024, NULL, PRIORITY_HIGH, NULL);
}
